name: iOS IPA Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ipa:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      
      - name: Install dependencies
        run: |
          cd app
          flutter pub get
      
      - name: Setup CocoaPods
        run: |
          cd app/ios
          pod install
      
      # Seçenek 1: Codesign ile IPA (Apple Developer hesabı gerekli)
      # - name: Import Code Signing Certificate
      #   uses: apple-actions/import-codesign-certs@v2
      #   with:
      #     p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
      #     p12-password: ${{ secrets.CERTIFICATES_PASSWORD }}
      # 
      # - name: Build IPA with Codesign
      #   run: |
      #     cd app
      #     flutter build ipa --release
      
      # Seçenek 2: Codesign olmadan build (Test için)
      - name: Build iOS (No Codesign)
        run: |
          cd app
          flutter build ios --release --no-codesign
      
      - name: Create IPA manually
        run: |
          cd app/build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../expense_tracker.ipa Payload
          rm -rf Payload
      
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: expense-tracker-ipa
          path: app/build/expense_tracker.ipa
          retention-days: 30
      
      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-info
          path: app/build/ios/iphoneos/Runner.app
          retention-days: 7

